<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Hospital Appointment Bot</title>

<style>
body {
  font-family: Arial;
  background:#f4f6f9;
  margin:0;
}

.chatbot-container {
  width:380px;
  height:650px;
  background:white;
  position:fixed;
  bottom:20px;
  right:20px;
  border-radius:15px;
  box-shadow:0 0 20px rgba(0,0,0,0.2);
  display:flex;
  flex-direction:column;
  overflow:hidden;
}

.chat-header {
  background:#0077ff;
  color:white;
  padding:15px;
  font-weight:bold;
  text-align:center;
  font-size:16px;
}

.chat-box {
  flex:1;
  padding:12px;
  overflow-y:auto;
  display:flex;
  flex-direction:column;
  background:#f9fbff;
}

.msg {
  padding:10px;
  margin:6px 0;
  border-radius:10px;
  max-width:85%;
  font-size:14px;
  white-space:pre-line;
}

.bot { background:#e3edff; align-self:flex-start; }
.user { background:#0077ff; color:white; align-self:flex-end; }

.chat-input { display:flex; border-top:1px solid #ddd; }

input {
  flex:1;
  padding:12px;
  border:none;
  outline:none;
}

button {
  padding:12px 15px;
  border:none;
  background:#0077ff;
  color:white;
  cursor:pointer;
}
button:hover { background:#005ed1; }

.download-btn {
  background:green;
  padding:8px 10px;
  border-radius:6px;
  margin-top:6px;
  display:inline-block;
  cursor:pointer;
  font-size:13px;
}
.download-btn:hover { background:darkgreen; }

.restart-btn {
  background:#ff9800;
  padding:6px 10px;
  border-radius:6px;
  margin-top:8px;
  display:inline-block;
  cursor:pointer;
  font-size:12px;
}
.restart-btn:hover { background:#e68900; }

</style>
</head>

<body>

<div class="chatbot-container">
  <div class="chat-header">üè• Hospital Appointment Bot</div>
  <div class="chat-box" id="chatBox"></div>
  <div class="chat-input">
    <input type="text" id="userInput" placeholder="Type here..." />
    <button onclick="sendMessage()">Send</button>
  </div>
</div>

<script>

let step = 0;
let appointment = {};
let statesList=[], citiesList=[], hospitalsList=[], doctorsList=[], freeSlots=[];
const chatBox=document.getElementById("chatBox");
const userInput=document.getElementById("userInput");

function addMessage(text, sender){
  const msg=document.createElement("div");
  msg.classList.add("msg", sender);
  msg.innerText=text;
  chatBox.appendChild(msg);
  chatBox.scrollTop=chatBox.scrollHeight;
}

function addDownloadButton(apptId){
  const container=document.createElement("div");
  container.classList.add("msg","bot");

  container.innerHTML=`
    üìÑ Appointment Slip Ready<br>
    <div class="download-btn" onclick="window.open('/pdf/${apptId}','_blank')">
      Download PDF
    </div>
    <div class="restart-btn" onclick="restartBooking()">
      Book Another Appointment
    </div>
  `;

  chatBox.appendChild(container);
  chatBox.scrollTop=chatBox.scrollHeight;
}

function botReply(text){
  setTimeout(()=>addMessage(text,"bot"),300);
}

function restartBooking(){
  resetBooking();
  botReply("Type 'book' to start a new appointment.");
}

function resetBooking(){
  step=0;
  appointment={};
  statesList=[];
  citiesList=[];
  hospitalsList=[];
  doctorsList=[];
  freeSlots=[];
}

botReply("Hello üëã Welcome!\n\nType 'book' to book an appointment.");

async function fetchJSON(url,options={}){
  try{
    const res=await fetch(url,options);
    return await res.json();
  }catch{
    botReply("‚ö†Ô∏è Server error. Please try again.");
    return [];
  }
}

async function sendMessage(){
  const text=userInput.value.trim();
  if(!text) return;
  addMessage(text,"user");
  userInput.value="";

  if(step===0){
    if(text.toLowerCase()==="book"){
      botReply("What is your name?");
      step=1;
    } else botReply("Please type 'book' to start booking.");
  }

  else if(step===1){
    appointment.name=text;
    botReply("Enter phone number:");
    step=2;
  }

  else if(step===2){
    appointment.phone=text;
    botReply("Fetching states...");
    statesList=await fetchJSON("/states");
    if(!statesList.length){botReply("No states available.");return;}
    let msg="Select State:\n\n";
    statesList.forEach((s,i)=>msg+=`${i+1}) ${s}\n`);
    botReply(msg);
    step=3;
  }

  else if(step===3){
    const idx=parseInt(text)-1;
    if(idx<0||idx>=statesList.length){botReply("Invalid state.");return;}
    appointment.state=statesList[idx];
    botReply("Fetching cities...");
    citiesList=await fetchJSON(`/cities/${encodeURIComponent(appointment.state)}`);
    if(!citiesList.length){botReply("No cities found.");return;}
    let msg="Select City:\n\n";
    citiesList.forEach((c,i)=>msg+=`${i+1}) ${c}\n`);
    botReply(msg);
    step=4;
  }

  else if(step===4){
    const idx=parseInt(text)-1;
    if(idx<0||idx>=citiesList.length){botReply("Invalid city.");return;}
    appointment.city=citiesList[idx];
    botReply("Fetching hospitals...");
    hospitalsList=await fetchJSON("/hospitals",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({state:appointment.state,city:appointment.city})
    });
    if(!hospitalsList.length){botReply("No hospitals found.");return;}
    let msg="Select Hospital:\n\n";
    hospitalsList.forEach((h,i)=>msg+=`${i+1}) ${h}\n`);
    botReply(msg);
    step=5;
  }

  else if(step===5){
    const idx=parseInt(text)-1;
    if(idx<0||idx>=hospitalsList.length){botReply("Invalid hospital.");return;}
    appointment.hospital=hospitalsList[idx];
    botReply("Select Department:\n1) ENT\n2) Cardiology\n3) Dental\n4) General");
    step=6;
  }

  else if(step===6){
    const map={"1":"ENT","2":"Cardiology","3":"Dental","4":"General"};
    if(!map[text]){botReply("Invalid department.");return;}
    appointment.department=map[text];
    doctorsList=await fetchJSON(`/doctors/${map[text]}`);
    if(!doctorsList.length){botReply("No doctors found.");return;}
    let msg="Select Doctor:\n\n";
    doctorsList.forEach((d,i)=>msg+=`${i+1}) ${d.name} (${d.timing})\n`);
    botReply(msg);
    step=7;
  }

  else if(step===7){
    const idx=parseInt(text)-1;
    if(idx<0||idx>=doctorsList.length){botReply("Invalid doctor.");return;}
    appointment.doctor=doctorsList[idx].name;
    botReply("Enter Date (DD-MM-YYYY):");
    step=8;
  }

  else if(step===8){
    appointment.date=text;
    freeSlots=await fetchJSON("/available_slots",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({doctor:appointment.doctor,date:text})
    });
    if(!freeSlots.length){botReply("No slots available.");return;}
    let msg="Select Time Slot:\n\n";
    freeSlots.forEach((s,i)=>msg+=`${i+1}) ${s}\n`);
    botReply(msg);
    step=9;
  }

  else if(step===9){
    const idx=parseInt(text)-1;
    if(idx<0||idx>=freeSlots.length){botReply("Invalid slot.");return;}
    appointment.time=freeSlots[idx];

    const result=await fetchJSON("/book",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify(appointment)
    });

    if(result.success){
      botReply(
        "‚úÖ Appointment Confirmed üéâ\n\n"+
        `üë§ ${appointment.name}\n`+
        `üè• ${appointment.hospital}\n`+
        `üë®‚Äç‚öïÔ∏è ${appointment.doctor}\n`+
        `üìÖ ${appointment.date}\n`+
        `‚è∞ ${appointment.time}`
      );
      addDownloadButton(result.appointment_id);
    }
    else{
      botReply(result.message || "Booking failed.");
    }

    resetBooking();
  }
}

userInput.addEventListener("keypress",e=>{ if(e.key==="Enter") sendMessage(); });

</script>

</body>
</html>